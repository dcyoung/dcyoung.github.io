<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.26.2 by Michael Rose
  Copyright 2013-2024 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->

<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>360 Panoramas (Alignment, Stitching, Blending)</title>
<meta name="description" content="Creating 360 panoramas from a set of images.">


  <meta name="author" content="David Young">


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="David Young">
<meta property="og:title" content="360 Panoramas (Alignment, Stitching, Blending)">
<meta property="og:url" content="https://dcyoung.github.io/pages/dcyoung/post-image-panoramas/">


  <meta property="og:description" content="Creating 360 panoramas from a set of images.">



  <meta property="og:image" content="https://dcyoung.github.io/pages/dcyoung/images/image-panoramas/0.webp">





  <meta property="article:published_time" content="2015-10-01T07:00:00+07:00">



  <meta property="article:modified_time" content="2015-10-01T07:00:00+07:00">




<link rel="canonical" href="https://dcyoung.github.io/pages/dcyoung/post-image-panoramas/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "David Young",
      "url": "https://dcyoung.github.io/pages/dcyoung/",
      "sameAs": ["https://www.linkedin.com/in/david-young-09509210a"]
    
  }
</script>






<!-- end _includes/seo.html -->


  <link href="/pages/dcyoung/feed.xml" type="application/atom+xml" rel="alternate" title="David Young Feed">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script type="text/javascript">
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
  
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/pages/dcyoung/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css"></noscript>



    <!-- start custom head snippets -->
<link rel="shortcut icon" href="/images/site/favicon.ico">
<meta name="theme-color" content="#ffffff">

<!-- end custom head snippets -->

<script type="text/javascript" async
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML">
</script>
<meta name="google-site-verification" content="zewSCzlO5JWAuo7MV_u4VoTRLfV4lUrqwxvfo4-3Xfc" />
<script type="text/x-mathjax-config">
   MathJax.Hub.Config({
     extensions: ["tex2jax.js"],
     jax: ["input/TeX", "output/HTML-CSS"],
     tex2jax: {
       inlineMath: [ ['$','$'], ["\\(","\\)"] ],
       displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
       processEscapes: true,
       preview: 'none'
     },
     messageStyle: 'none',
     "HTML-CSS": { availableFonts: ["TeX"] }
   });

</script>

<style>
    .bg-color-red {
        background-color: #ffebee;
    }

    .bg-color-green {
        background-color: #e8f5e9;
    }

    .bg-color-yellow {
        background-color: #fff3e0;
    }

    .bg-color-dark-green {
        background-color: #c8e6c9;
    }

    .bg-color-pink {
        background-color: #ffcdd2;
    }

    .bg-color-purple {
        background-color: #c5cae9;
    }

    .pwc-icon {
        width: 23px;
        height: 23px;
        position: relative;
        top: 5px;
        margin-right: 5px;
    }

</style>

  </head>

  <body class="layout--single wide" dir="ltr">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/pages/dcyoung/">
          David Young
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a
                href="/pages/dcyoung/archives/"
                
                
              >Posts</a>
            </li><li class="masthead__menu-item">
              <a
                href="/pages/dcyoung/about/"
                
                
              >About</a>
            </li><li class="masthead__menu-item">
              <a
                href="/pages/dcyoung/resume/"
                
                
              >Resume</a>
            </li><li class="masthead__menu-item">
              <a
                href="/pages/dcyoung/ml-practitioners-guide/"
                
                
              >ML Practitioner's Guide</a>
            </li><li class="masthead__menu-item">
              <a
                href="/pages/dcyoung/categories/"
                
                
              >Categories</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <i class="fas fa-search"></i>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      





<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person" class="h-card">

  
    <div class="author__avatar">
      <a href="https://dcyoung.github.io/pages/dcyoung/">
        <img src="/pages/dcyoung/images/site/profile_artsy.webp" alt="David Young" itemprop="image" class="u-photo">
      </a>
    </div>
  

  <div class="author__content">
    <h3 class="author__name p-name" itemprop="name">
      <a class="u-url" rel="me" href="https://dcyoung.github.io/pages/dcyoung/" itemprop="url">David Young</a>
    </h3>
    
      <div class="author__bio p-note" itemprop="description">
        <p>systems thinker &amp; passionate engineer</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      

      
        
          
            <li><a href="https://github.com/dcyoung" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
          
        
          
            <li><a href="https://www.linkedin.com/in/david-young-09509210a" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span class="label">Linkedin</span></a></li>
          
        
          
            <li><a href="https://www.instagram.com/cycle_shadez/" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-instagram" aria-hidden="true"></i><span class="label">Instagram</span></a></li>
          
        
          
            <li><a href="https://www.youtube.com/channel/UClQEBd-MzkWlkjbxcsve-UA" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-youtube" aria-hidden="true"></i><span class="label">YouTube</span></a></li>
          
        
          
            <li><a href="mailto:david@questionablyartificial.com" rel="nofollow noopener noreferrer me"><i class="fab fa-fw fa-envelope" aria-hidden="true"></i><span class="label">Email</span></a></li>
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer me">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="360 Panoramas (Alignment, Stitching, Blending)">
    <meta itemprop="description" content="Creating 360 panoramas from a set of images.">
    <meta itemprop="datePublished" content="2015-10-01T07:00:00+07:00">
    <meta itemprop="dateModified" content="2015-10-01T07:00:00+07:00">

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">
            <a href="https://dcyoung.github.io/pages/dcyoung/post-image-panoramas/" itemprop="url">360 Panoramas (Alignment, Stitching, Blending)
</a>
          </h1>
          

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          13 minute read
        
      </span>
    
  </p>


        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right ">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> On this page</h4></header>
              <ul class="toc__menu"><li><a href="#creating-panoramas">Creating Panoramas</a></li><li><a href="#overview--major-design-choices">Overview + Major Design Choices</a></li><li><a href="#resulting-panoramas">Resulting Panoramas</a></li><li><a href="#removing-radial-distortion--warping-images-to-spherical-coordinates">Removing Radial Distortion &amp; Warping Images to Spherical Coordinates</a></li><li><a href="#aligning-warped-images-using-ransac">Aligning Warped Images using RANSAC</a></li><li><a href="#stitch-and-crop-the-resulting-aligned-image">Stitch and Crop the Resulting Aligned Image</a><ul><li><a href="#determining-the-absolute-bounds-of-the-panorama--blending-images">Determining the Absolute Bounds of the Panorama + Blending Images</a></li><li><a href="#accumulating-the-blend">Accumulating the Blend</a></li><li><a href="#normalizing-the-blend">Normalizing the Blend</a></li></ul></li><li><a href="#what-worked-well-and-what-did-not">What worked well and what did not?</a></li></ul>
            </nav>
          </aside>
        
        <h2 id="creating-panoramas">Creating Panoramas</h2>

<p>The idea behind this project was to take a set of images (about 15-20) and create a panorama of a full 360 degree scene. The code written previously to detect and describe features (I’ve described that fully elsewhere on the website) can serve as the foundation of a panorama generator. The code shown here is just an outline for the panorama generating portions of the pipeline.</p>

<h2 id="overview--major-design-choices">Overview + Major Design Choices</h2>

<p>The general process is as follows:</p>

<ul>
  <li>Warp each image into spherical coordinates.</li>
  <li>Determine the features for each warped image. (click HERE to see Feature Detection and HERE to see feature Description)</li>
  <li>Match features between every pair of adjacent images. (click HERE to see Feature Matching)</li>
  <li>Align every pair of adjacent images using RANSAC.</li>
  <li>Blend the aligned images to create a panorama.</li>
</ul>

<h2 id="resulting-panoramas">Resulting Panoramas</h2>

<p>A few different panorama’s were generated and the results are shown below. The first is the result of images available in similar project packages around the web, I did not take the source images for the 1st panorama. The 2nd and 3rd panoramas are of the main entrance to Wash U, with and without me in the photos.  The 3rd and 4th panoramas are of the Kemper art museum on Wash U campus with and without my friend Robert in the photos. The alignment and corrections are working well, but this could use a more robust mechanism to account for changes in illumination between adjacent photos.</p>

<p><a href="/images/image-panoramas/0.webp"><img src="/images/image-panoramas/0.webp" alt="panorama" class="align-center" /></a>
<a href="/images/image-panoramas/1.webp"><img src="/images/image-panoramas/1.webp" alt="panorama" class="align-center" /></a>
<a href="/images/image-panoramas/2.webp"><img src="/images/image-panoramas/2.webp" alt="panorama" class="align-center" /></a>
<a href="/images/image-panoramas/3.webp"><img src="/images/image-panoramas/3.webp" alt="panorama" class="align-center" /></a>
<a href="/images/image-panoramas/4.webp"><img src="/images/image-panoramas/4.webp" alt="panorama" class="align-center" /></a></p>

<h2 id="removing-radial-distortion--warping-images-to-spherical-coordinates">Removing Radial Distortion &amp; Warping Images to Spherical Coordinates</h2>

<p>The following method contains all the logic for warping an image to spherical coordinates as well as applying a radial distortion.</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">CFloatImage</span> <span class="nf">WarpSphericalField</span><span class="p">(</span><span class="n">CShape</span> <span class="n">srcSh</span><span class="p">,</span> <span class="n">CShape</span> <span class="n">dstSh</span><span class="p">,</span> <span class="kt">float</span> <span class="n">f</span><span class="p">,</span> <span class="kt">float</span> <span class="n">k1</span><span class="p">,</span> <span class="kt">float</span> <span class="n">k2</span><span class="p">,</span> <span class="k">const</span> <span class="n">CTransform3x3</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="c1">// Set up the pixel coordinate image</span>
		<span class="n">dstSh</span><span class="p">.</span><span class="n">nBands</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">CFloatImage</span> <span class="n">uvImg</span><span class="p">(</span><span class="n">dstSh</span><span class="p">);</span>   <span class="c1">// ( u,v ) coordinates</span>

		<span class="c1">// Fill in the values</span>
		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">dstSh</span><span class="p">.</span><span class="n">height</span><span class="p">;</span> <span class="n">y</span><span class="o">++</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="kt">float</span> <span class="o">*</span><span class="n">uv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">uvImg</span><span class="p">.</span><span class="n">Pixel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">dstSh</span><span class="p">.</span><span class="n">width</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">,</span> <span class="n">uv</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="c1">// (x,y) is the spherical image coordinates. </span>
				<span class="c1">// (xf,yf) is the spherical coordinates, e.g., xf is the angle theta</span>
				<span class="c1">// and yf is the angle phi</span>

				<span class="kt">float</span> <span class="n">xf</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="mf">0.5</span><span class="n">f</span><span class="o">*</span><span class="n">dstSh</span><span class="p">.</span><span class="n">width</span> <span class="p">)</span> <span class="o">/</span> <span class="n">f</span><span class="p">;</span>
				<span class="kt">float</span> <span class="n">yf</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="mf">0.5</span><span class="n">f</span><span class="o">*</span><span class="n">dstSh</span><span class="p">.</span><span class="n">height</span><span class="p">)</span> <span class="o">/</span> <span class="n">f</span><span class="p">;</span>

				<span class="c1">// (xt,yt,zt) are intermediate coordinates to which you can</span>
				<span class="c1">// apply the spherical correction and radial distortion</span>
				<span class="kt">float</span> <span class="n">xt</span><span class="p">,</span> <span class="n">yt</span><span class="p">,</span> <span class="n">zt</span><span class="p">;</span>
				<span class="n">CVector3</span> <span class="n">p</span><span class="p">;</span>
	 
		
				<span class="c1">// apply the spherical correction, i.e.,</span>
				<span class="c1">// compute the Euclidean coordinates, rotate according to</span>
				<span class="c1">// r, and project the point to the z=1 plane at</span>
				<span class="c1">// (xt/zt,yt/zt,1), then distort with radial distortion</span>
				<span class="c1">// coefficients k1 and k2</span>

				<span class="c1">//convert the theta and phi to spherical coordinates </span>
				<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sin</span><span class="p">(</span><span class="n">xf</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">yf</span><span class="p">);</span>
				<span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sinf</span><span class="p">(</span><span class="n">yf</span><span class="p">);</span>
				<span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cos</span><span class="p">(</span><span class="n">xf</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">yf</span><span class="p">);</span>

				<span class="c1">//p = r*p; //p now holds the rotated spherical coordinates ?</span>

				<span class="c1">//normalize all the coordinates by z_hat</span>
				<span class="n">xt</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
				<span class="n">yt</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
				<span class="n">zt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				
				<span class="c1">//apply radial distortion</span>
				<span class="kt">float</span> <span class="n">r_squared</span> <span class="o">=</span> <span class="n">xt</span><span class="o">*</span><span class="n">xt</span> <span class="o">+</span> <span class="n">yt</span><span class="o">*</span><span class="n">yt</span><span class="p">;</span>
				<span class="n">xt</span> <span class="o">=</span> <span class="n">xt</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">k1</span><span class="o">*</span><span class="n">r_squared</span> <span class="o">+</span> <span class="n">k2</span><span class="o">*</span><span class="n">r_squared</span><span class="o">*</span><span class="n">r_squared</span><span class="p">);</span>
				<span class="n">yt</span> <span class="o">=</span> <span class="n">yt</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">k1</span><span class="o">*</span><span class="n">r_squared</span> <span class="o">+</span> <span class="n">k2</span><span class="o">*</span><span class="n">r_squared</span><span class="o">*</span><span class="n">r_squared</span><span class="p">);</span>

				<span class="c1">// Convert back to regular pixel coordinates and store</span>
				<span class="kt">float</span> <span class="n">xn</span> <span class="o">=</span> <span class="mf">0.5</span><span class="n">f</span><span class="o">*</span><span class="n">srcSh</span><span class="p">.</span><span class="n">width</span>  <span class="o">+</span> <span class="n">xt</span><span class="o">*</span><span class="n">f</span><span class="p">;</span>
				<span class="kt">float</span> <span class="n">yn</span> <span class="o">=</span> <span class="mf">0.5</span><span class="n">f</span><span class="o">*</span><span class="n">srcSh</span><span class="p">.</span><span class="n">height</span> <span class="o">+</span> <span class="n">yt</span><span class="o">*</span><span class="n">f</span><span class="p">;</span>
				<span class="n">uv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">xn</span><span class="p">;</span>
				<span class="n">uv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">yn</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">uvImg</span><span class="p">;</span>
	<span class="p">}</span>
</code></pre></div></div>

<h2 id="aligning-warped-images-using-ransac">Aligning Warped Images using RANSAC</h2>

<p>The followings code assumes the images warped by the previous code have undergone feature detection and description. That process  could be accomplished using code I’ve written in previous projects, or using state of the art approaches like SIFT. The following controller code functionally selects a random matching pair of features and computes the translation between the two feature locations. Then it calls countInliers to count how many matches agree with the estimate translation of f1 to f2. Repeating this nRANSAC times and keeping track of the best estimate (by number of inliers) is a good estimation. But to further define the exact value beyond an integer pixel, I sent the result off to leastSquaresFit which performs a least squares fit to determine an even better estimate.</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">alignPair</span><span class="p">(</span><span class="k">const</span> <span class="n">FeatureSet</span> <span class="o">&amp;</span><span class="n">f1</span><span class="p">,</span> <span class="k">const</span> <span class="n">FeatureSet</span> <span class="o">&amp;</span><span class="n">f2</span><span class="p">,</span>
	  <span class="k">const</span> <span class="n">vector</span> <span class="o">&amp;</span><span class="n">matches</span><span class="p">,</span> <span class="n">MotionModel</span> <span class="n">m</span><span class="p">,</span> <span class="kt">float</span> <span class="n">f</span><span class="p">,</span>
	  <span class="kt">int</span> <span class="n">nRANSAC</span><span class="p">,</span> <span class="kt">double</span> <span class="n">RANSACthresh</span><span class="p">,</span> <span class="n">CTransform3x3</span><span class="o">&amp;</span> <span class="n">M</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">bestIndex</span><span class="p">;</span>   <span class="c1">// holds index of match with most inclusive translation</span>
	<span class="kt">int</span> <span class="n">testIndex</span><span class="p">;</span>	 <span class="c1">// holds current index being tested for number of inliers</span>
	<span class="n">vector</span> <span class="n">bestIndexAssociatedInliers</span><span class="p">;</span> <span class="c1">//the indices of matches that follow the same translation as the bestIndex</span>
	<span class="kt">int</span> <span class="n">bestInlierCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">//number of inliers in bestIndexAssociatedInliers</span>
	
	<span class="n">FeatureMatch</span> <span class="n">match</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">xTrans</span><span class="p">,</span> <span class="n">yTrans</span><span class="p">;</span>
	<span class="n">Feature</span> <span class="n">feature1</span><span class="p">,</span> <span class="n">feature2</span><span class="p">;</span>
	<span class="n">CTransform3x3</span> <span class="n">transMatrix</span><span class="p">;</span>
	
	
	<span class="cm">/*repeat the following cycle:
		1. pick a random feature pair (ie: a feature and its match from the other image)
		2. determine the translation (ie: change in x and y that would be required to make 
			the coordinates of f1 equal to the coordinates of its match)
			for ex: if f1 was at pixel 4,7 and f2 was at pixel 5,8 in its coordinate space, then the required translation owuld be +1,+1
		3. apply that translation to every feature in f1Set and see if it is within tolerance of its match from f2Set
		4. if it is close enough to f2, count it as an inlier, if it isn't, do not count it. 
		5. keep track of the translation and the number of inliers.
	*/</span>

	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nRANSAC</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>

		<span class="n">testIndex</span> <span class="o">=</span> <span class="n">rand</span><span class="p">()</span> <span class="o">%</span> <span class="n">matches</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="c1">// provides a random index between 0 and the size of matches	</span>

		<span class="n">feature1</span> <span class="o">=</span> <span class="n">f1</span><span class="p">[</span><span class="n">matches</span><span class="p">[</span><span class="n">testIndex</span><span class="p">].</span><span class="n">id1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
		<span class="n">feature2</span> <span class="o">=</span> <span class="n">f2</span><span class="p">[</span><span class="n">matches</span><span class="p">[</span><span class="n">testIndex</span><span class="p">].</span><span class="n">id2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>

		<span class="n">xTrans</span> <span class="o">=</span> <span class="n">feature2</span><span class="p">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">feature1</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
		<span class="n">yTrans</span> <span class="o">=</span> <span class="n">feature2</span><span class="p">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">feature1</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
		
		<span class="n">transMatrix</span> <span class="o">=</span> <span class="n">CTransform3x3</span><span class="o">::</span><span class="n">Translation</span><span class="p">((</span><span class="kt">float</span><span class="p">)</span> <span class="n">xTrans</span><span class="p">,</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span> <span class="n">yTrans</span><span class="p">);</span>
		
		<span class="n">vector</span> <span class="n">inliers</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">countInliers</span><span class="p">(</span><span class="n">f1</span><span class="p">,</span> <span class="n">f2</span><span class="p">,</span> <span class="n">matches</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span><span class="n">transMatrix</span><span class="p">,</span> <span class="n">RANSACthresh</span><span class="p">,</span> <span class="n">inliers</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">bestInlierCount</span><span class="p">){</span>
			<span class="n">bestIndex</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">bestInlierCount</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
			<span class="n">bestIndexAssociatedInliers</span> <span class="o">=</span> <span class="n">inliers</span><span class="p">;</span>
			<span class="n">M</span> <span class="o">=</span> <span class="n">transMatrix</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span>
	
	<span class="n">leastSquaresFit</span><span class="p">(</span><span class="n">f1</span><span class="p">,</span> <span class="n">f2</span><span class="p">,</span><span class="n">matches</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">bestIndexAssociatedInliers</span><span class="p">,</span> <span class="n">M</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Counting inliers is fairly straightforward. For the given estimation, each possibility is checked against a threshold and a count is increased if the match is an inlier.</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">countInliers</span><span class="p">(</span><span class="k">const</span> <span class="n">FeatureSet</span> <span class="o">&amp;</span><span class="n">f1</span><span class="p">,</span> <span class="k">const</span> <span class="n">FeatureSet</span> <span class="o">&amp;</span><span class="n">f2</span><span class="p">,</span>
	 <span class="k">const</span> <span class="n">vector</span> <span class="o">&amp;</span><span class="n">matches</span><span class="p">,</span> <span class="n">MotionModel</span> <span class="n">m</span><span class="p">,</span> <span class="kt">float</span> <span class="n">f</span><span class="p">,</span>
	 <span class="n">CTransform3x3</span> <span class="n">M</span><span class="p">,</span> <span class="kt">double</span> <span class="n">RANSACthresh</span><span class="p">,</span> <span class="n">vector</span> <span class="o">&amp;</span><span class="n">inliers</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">inliers</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">matches</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		
		<span class="c1">// determine if the ith matched feature f1[id1-1], when transformed by M,</span>
		<span class="c1">// is within RANSACthresh of its match in f2</span>
		<span class="c1">//</span>
		<span class="c1">// if so, increment count and append i to inliers</span>
		<span class="c1">//</span>
		<span class="c1">// *NOTE* Each match contains two feature ids of matching features, id1 and id2.</span>
		<span class="c1">//        These ids are 1-based indices into the feature arrays,</span>
		<span class="c1">//        so access the appropriate features as f1[id1-1] and f2[id2-1].</span>


		<span class="n">CVector3</span> <span class="n">feat1Vec</span> <span class="o">=</span> <span class="n">CVector3</span><span class="p">();</span>
		<span class="n">Feature</span> <span class="n">testF1</span> <span class="o">=</span> <span class="n">f1</span><span class="p">[</span><span class="n">matches</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
		<span class="n">Feature</span> <span class="n">testF2</span> <span class="o">=</span> <span class="n">f2</span><span class="p">[</span><span class="n">matches</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>

		<span class="n">feat1Vec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">testF1</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
		<span class="n">feat1Vec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">testF1</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
		<span class="n">feat1Vec</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">CVector3</span> <span class="n">translatedF1</span> <span class="o">=</span> <span class="n">M</span><span class="o">*</span><span class="n">feat1Vec</span><span class="p">;</span>
		<span class="kt">float</span> <span class="n">dx</span> <span class="o">=</span> <span class="n">testF2</span><span class="p">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">translatedF1</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="kt">float</span> <span class="n">dy</span> <span class="o">=</span> <span class="n">testF2</span><span class="p">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">translatedF1</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="kt">float</span> <span class="n">distError</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">dx</span><span class="o">*</span><span class="n">dx</span><span class="o">+</span><span class="n">dy</span><span class="o">*</span><span class="n">dy</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">distError</span> <span class="o">&lt;=</span> <span class="n">RANSACthresh</span><span class="p">){</span>
			<span class="n">inliers</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
			<span class="n">count</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Performing a least Squares Fit here is simple because of the restricted degrees of freedom. The average translation vector yields the result.</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">leastSquaresFit</span><span class="p">(</span><span class="k">const</span> <span class="n">FeatureSet</span> <span class="o">&amp;</span><span class="n">f1</span><span class="p">,</span> <span class="k">const</span> <span class="n">FeatureSet</span> <span class="o">&amp;</span><span class="n">f2</span><span class="p">,</span>
		<span class="k">const</span> <span class="n">vector</span> <span class="o">&amp;</span><span class="n">matches</span><span class="p">,</span> <span class="n">MotionModel</span> <span class="n">m</span><span class="p">,</span> <span class="kt">float</span> <span class="n">f</span><span class="p">,</span>
		<span class="k">const</span> <span class="n">vector</span> <span class="o">&amp;</span><span class="n">inliers</span><span class="p">,</span> <span class="n">CTransform3x3</span><span class="o">&amp;</span> <span class="n">M</span><span class="p">)</span>
<span class="p">{</span>

	<span class="c1">// for panoramas the transformation is a translation and</span>
	<span class="c1">// only has two degrees of freedom</span>
	<span class="c1">//</span>
	<span class="c1">// therefore, simply compute the average translation vector</span>
	<span class="c1">// between the feature in f1 and its match in f2 for all inliers</span>
	<span class="kt">double</span> <span class="n">u</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">double</span> <span class="n">v</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	
	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">inliers</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">double</span> <span class="n">xTrans</span><span class="p">,</span> <span class="n">yTrans</span><span class="p">;</span>

		<span class="c1">// compute the translation implied by the ith inlier match</span>
		<span class="c1">// and store it in (xTrans,yTrans)</span>

	
		<span class="n">Feature</span> <span class="n">testF1</span> <span class="o">=</span> <span class="n">f1</span><span class="p">[</span><span class="n">matches</span><span class="p">[</span><span class="n">inliers</span><span class="p">[</span><span class="n">i</span><span class="p">]].</span><span class="n">id1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
		<span class="n">Feature</span> <span class="n">testF2</span> <span class="o">=</span> <span class="n">f2</span><span class="p">[</span><span class="n">matches</span><span class="p">[</span><span class="n">inliers</span><span class="p">[</span><span class="n">i</span><span class="p">]].</span><span class="n">id2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
		
		<span class="n">xTrans</span> <span class="o">=</span> <span class="n">testF2</span><span class="p">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">testF1</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
		<span class="n">yTrans</span> <span class="o">=</span> <span class="n">testF2</span><span class="p">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">testF1</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>

	
		<span class="n">u</span> <span class="o">+=</span> <span class="n">xTrans</span><span class="p">;</span>
		<span class="n">v</span> <span class="o">+=</span> <span class="n">yTrans</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">u</span> <span class="o">/=</span> <span class="n">inliers</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
	<span class="n">v</span> <span class="o">/=</span> <span class="n">inliers</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>

	<span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">u</span><span class="p">;</span>
	<span class="n">M</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">M</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">M</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">v</span><span class="p">;</span>
	<span class="n">M</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">M</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">M</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="stitch-and-crop-the-resulting-aligned-image">Stitch and Crop the Resulting Aligned Image</h2>

<p>The basic outline here is to stitch the aligned images. Given warped images and their displacements, I figure out the max and min corners to determine the overall dimensions of the panorama. I also determine the absolute displacements of each image in the final panorama coordinate space given their relative displacements from each other. This is all accomplished in blendImages. Then I blend each image with its adjacent images in the panorama in AccumulateBlend and Normalize Blend. Here i use a feathering function that is simply a ratio equal to the slope of a line defined by the blendwidth. Technically this is a 1d version of a distance map. Normalizing the blend occurs after the feathering. Finally the resulting image is transformed using a an affine shear matrix, because in this case the only translation is in the y direction. Therefore a shear can revert things back to normal.</p>

<h3 id="determining-the-absolute-bounds-of-the-panorama--blending-images">Determining the Absolute Bounds of the Panorama + Blending Images</h3>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">CByteImage</span> <span class="nf">BlendImages</span><span class="p">(</span><span class="n">CImagePositionV</span><span class="o">&amp;</span> <span class="n">ipv</span><span class="p">,</span> <span class="kt">float</span> <span class="n">blendWidth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="c1">// Assume all the images are of the same shape (for now)</span>
	<span class="n">CByteImage</span><span class="o">&amp;</span> <span class="n">img0</span> <span class="o">=</span> <span class="n">ipv</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">img</span><span class="p">;</span>
	<span class="n">CShape</span> <span class="n">sh</span>        <span class="o">=</span> <span class="n">img0</span><span class="p">.</span><span class="n">Shape</span><span class="p">();</span>
	<span class="kt">int</span> <span class="n">width</span>        <span class="o">=</span> <span class="n">sh</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">height</span>       <span class="o">=</span> <span class="n">sh</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nBands</span>       <span class="o">=</span> <span class="n">sh</span><span class="p">.</span><span class="n">nBands</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dim</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>       <span class="o">=</span> <span class="p">{</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">};</span>
	

	<span class="c1">// Compute the bounding box for the mosaic</span>
	<span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">ipv</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
	<span class="kt">float</span> <span class="n">min_x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">min_y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">float</span> <span class="n">max_x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">max_y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		
		<span class="n">CTransform3x3</span> <span class="o">&amp;</span><span class="n">pos</span> <span class="o">=</span> <span class="n">ipv</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">position</span><span class="p">;</span>

		<span class="n">CVector3</span> <span class="n">corners</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

		<span class="n">corners</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
		<span class="n">corners</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
		<span class="n">corners</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">;</span>

		<span class="n">corners</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">corners</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
		<span class="n">corners</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">;</span>

		<span class="n">corners</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
		<span class="n">corners</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">corners</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">;</span>

		<span class="n">corners</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">corners</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">corners</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">;</span>

		<span class="n">corners</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">*</span> <span class="n">corners</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">corners</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">*</span> <span class="n">corners</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">corners</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">*</span> <span class="n">corners</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="n">corners</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">*</span> <span class="n">corners</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

		<span class="n">corners</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">/=</span> <span class="n">corners</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">];</span>
		<span class="n">corners</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">/=</span> <span class="n">corners</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">];</span>

		<span class="n">corners</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">/=</span> <span class="n">corners</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">];</span>
		<span class="n">corners</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">/=</span> <span class="n">corners</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">];</span>

		<span class="n">corners</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">/=</span> <span class="n">corners</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">];</span>
		<span class="n">corners</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">/=</span> <span class="n">corners</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">];</span>

		<span class="n">corners</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">/=</span> <span class="n">corners</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">];</span>
		<span class="n">corners</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">/=</span> <span class="n">corners</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">];</span>
		
		<span class="c1">// update min_x, ..., max_y</span>
		
		<span class="c1">//check the corners to see if an x or y is smaller/larger than the running min/max and update the running version if so.</span>
		<span class="n">min_x</span> <span class="o">=</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">MIN</span><span class="p">(</span><span class="n">min_x</span><span class="p">,</span> <span class="n">corners</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">min_x</span> <span class="o">=</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">MIN</span><span class="p">(</span><span class="n">min_x</span><span class="p">,</span> <span class="n">corners</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">min_x</span> <span class="o">=</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">MIN</span><span class="p">(</span><span class="n">min_x</span><span class="p">,</span> <span class="n">corners</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">min_x</span> <span class="o">=</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">MIN</span><span class="p">(</span><span class="n">min_x</span><span class="p">,</span> <span class="n">corners</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">]);</span>

		<span class="n">min_y</span> <span class="o">=</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">MIN</span><span class="p">(</span><span class="n">min_y</span><span class="p">,</span> <span class="n">corners</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">min_y</span> <span class="o">=</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">MIN</span><span class="p">(</span><span class="n">min_y</span><span class="p">,</span> <span class="n">corners</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">min_y</span> <span class="o">=</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">MIN</span><span class="p">(</span><span class="n">min_y</span><span class="p">,</span> <span class="n">corners</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">min_y</span> <span class="o">=</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">MIN</span><span class="p">(</span><span class="n">min_y</span><span class="p">,</span> <span class="n">corners</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">]);</span>

		<span class="n">max_x</span> <span class="o">=</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">MAX</span><span class="p">(</span><span class="n">max_x</span><span class="p">,</span> <span class="n">corners</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">max_x</span> <span class="o">=</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">MAX</span><span class="p">(</span><span class="n">max_x</span><span class="p">,</span> <span class="n">corners</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">max_x</span> <span class="o">=</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">MAX</span><span class="p">(</span><span class="n">max_x</span><span class="p">,</span> <span class="n">corners</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">max_x</span> <span class="o">=</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">MAX</span><span class="p">(</span><span class="n">max_x</span><span class="p">,</span> <span class="n">corners</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">]);</span>

		<span class="n">max_y</span> <span class="o">=</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">MAX</span><span class="p">(</span><span class="n">max_y</span><span class="p">,</span> <span class="n">corners</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">max_y</span> <span class="o">=</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">MAX</span><span class="p">(</span><span class="n">max_y</span><span class="p">,</span> <span class="n">corners</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">max_y</span> <span class="o">=</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">MAX</span><span class="p">(</span><span class="n">max_y</span><span class="p">,</span> <span class="n">corners</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">max_y</span> <span class="o">=</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">MAX</span><span class="p">(</span><span class="n">max_y</span><span class="p">,</span> <span class="n">corners</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="c1">// Create a floating point accumulation image</span>
	<span class="n">CShape</span> <span class="n">mShape</span><span class="p">((</span><span class="kt">int</span><span class="p">)(</span><span class="n">ceil</span><span class="p">(</span><span class="n">max_x</span><span class="p">)</span> <span class="o">-</span> <span class="n">floor</span><span class="p">(</span><span class="n">min_x</span><span class="p">)),</span>
				  <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">ceil</span><span class="p">(</span><span class="n">max_y</span><span class="p">)</span> <span class="o">-</span> <span class="n">floor</span><span class="p">(</span><span class="n">min_y</span><span class="p">)),</span> <span class="n">nBands</span><span class="p">);</span>
	<span class="n">CFloatImage</span> <span class="n">accumulator</span><span class="p">(</span><span class="n">mShape</span><span class="p">);</span>
	<span class="n">accumulator</span><span class="p">.</span><span class="n">ClearPixels</span><span class="p">();</span>

	<span class="kt">double</span> <span class="n">x_init</span><span class="p">,</span> <span class="n">x_final</span><span class="p">;</span>
	<span class="kt">double</span> <span class="n">y_init</span><span class="p">,</span> <span class="n">y_final</span><span class="p">;</span>

	<span class="c1">// Add in all of the images</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		
		<span class="n">CTransform3x3</span> <span class="o">&amp;</span><span class="n">M</span> <span class="o">=</span> <span class="n">ipv</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">position</span><span class="p">;</span>

		<span class="n">CTransform3x3</span> <span class="n">M_t</span> <span class="o">=</span> <span class="n">CTransform3x3</span><span class="o">::</span><span class="n">Translation</span><span class="p">(</span><span class="o">-</span><span class="n">min_x</span><span class="p">,</span> <span class="o">-</span><span class="n">min_y</span><span class="p">)</span> <span class="o">*</span> <span class="n">M</span><span class="p">;</span>

		<span class="n">CByteImage</span><span class="o">&amp;</span> <span class="n">img</span> <span class="o">=</span> <span class="n">ipv</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">img</span><span class="p">;</span>

		<span class="c1">// Perform the accumulation</span>
		<span class="n">AccumulateBlend</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">accumulator</span><span class="p">,</span> <span class="n">M_t</span><span class="p">,</span> <span class="n">blendWidth</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">CVector3</span> <span class="n">p</span><span class="p">;</span>
			<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">width</span><span class="p">;</span>
			<span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
			<span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">;</span>

			<span class="n">p</span> <span class="o">=</span> <span class="n">M_t</span> <span class="o">*</span> <span class="n">p</span><span class="p">;</span>
			<span class="n">x_init</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">y_init</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">CVector3</span> <span class="n">p</span><span class="p">;</span>
			<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">width</span><span class="p">;</span>
			<span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
			<span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">;</span>

			<span class="n">p</span> <span class="o">=</span> <span class="n">M_t</span> <span class="o">*</span> <span class="n">p</span><span class="p">;</span>
			<span class="n">x_final</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">y_final</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="p">}</span>
	<span class="p">}</span>



	<span class="c1">// Normalize the results</span>
	<span class="n">CByteImage</span> <span class="n">compImage</span><span class="p">(</span><span class="n">mShape</span><span class="p">);</span>
	<span class="n">NormalizeBlend</span><span class="p">(</span><span class="n">accumulator</span><span class="p">,</span> <span class="n">compImage</span><span class="p">);</span>
	<span class="kt">bool</span> <span class="n">debug_comp</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug_comp</span><span class="p">)</span>
		<span class="n">WriteFile</span><span class="p">(</span><span class="n">compImage</span><span class="p">,</span> <span class="s">"tmp_comp.tga"</span><span class="p">);</span>

	<span class="c1">// Allocate the final image shape</span>
	<span class="n">CShape</span> <span class="n">cShape</span><span class="p">(</span><span class="n">mShape</span><span class="p">.</span><span class="n">width</span> <span class="o">-</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">nBands</span><span class="p">);</span>
	<span class="n">CByteImage</span> <span class="n">croppedImage</span><span class="p">(</span><span class="n">cShape</span><span class="p">);</span>

	<span class="c1">// Compute the affine deformation</span>
	<span class="n">CTransform3x3</span> <span class="n">A</span><span class="p">;</span>

	<span class="c1">// A will trim the left edge and take out the vertical drift</span>
	
	
	<span class="c1">//if (true){ /*the image is built from the left*/</span>
		<span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">min_y</span> <span class="o">-</span> <span class="n">max_y</span> <span class="o">+</span> <span class="n">height</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">max_x</span> <span class="o">-</span> <span class="n">min_x</span><span class="p">);</span> <span class="c1">//shear</span>
	<span class="c1">//}</span>
	<span class="c1">//else{ /*the image is built from the right, like the campus image set*/</span>
	<span class="c1">//	A[1][0] = (min_y - max_y + height) / (max_x - min_x); //shear</span>
	<span class="c1">//	A[1][2] = -(min_y - max_y + height); //y translation</span>
	<span class="c1">//}</span>

	<span class="c1">// Warp and crop the composite</span>
	<span class="n">WarpGlobal</span><span class="p">(</span><span class="n">compImage</span><span class="p">,</span> <span class="n">croppedImage</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">eWarpInterpLinear</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">croppedImage</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="accumulating-the-blend">Accumulating the Blend</h3>

<p>Here I blend each image with its adjacent images in the panorama using the feathering function outlined previously.</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="kt">void</span> <span class="nf">AccumulateBlend</span><span class="p">(</span><span class="n">CByteImage</span><span class="o">&amp;</span> <span class="n">img</span><span class="p">,</span> <span class="n">CFloatImage</span><span class="o">&amp;</span> <span class="n">acc</span><span class="p">,</span> <span class="n">CTransform3x3</span> <span class="n">M</span><span class="p">,</span> <span class="kt">float</span> <span class="n">blendWidth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Compute the bounding box of the image of the image */</span>
	<span class="kt">int</span> <span class="n">bb_min_x</span><span class="p">,</span> <span class="n">bb_min_y</span><span class="p">,</span> <span class="n">bb_max_x</span><span class="p">,</span> <span class="n">bb_max_y</span><span class="p">;</span>
	<span class="n">ImageBoundingBox</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">bb_min_x</span><span class="p">,</span> <span class="n">bb_min_y</span><span class="p">,</span> <span class="n">bb_max_x</span><span class="p">,</span> <span class="n">bb_max_y</span><span class="p">);</span>

	<span class="n">CTransform3x3</span> <span class="n">Minv</span> <span class="o">=</span> <span class="n">M</span><span class="p">.</span><span class="n">Inverse</span><span class="p">();</span>

	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">y</span> <span class="o">=</span> <span class="n">bb_min_y</span><span class="p">;</span> <span class="n">y</span> <span class="o">&lt;=</span> <span class="n">bb_max_y</span><span class="p">;</span> <span class="n">y</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="n">bb_min_x</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">bb_max_x</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Check bounds in destination */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="n">acc</span><span class="p">.</span><span class="n">Shape</span><span class="p">().</span><span class="n">width</span> <span class="o">||</span> 
				<span class="n">y</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">y</span> <span class="o">&gt;=</span> <span class="n">acc</span><span class="p">.</span><span class="n">Shape</span><span class="p">().</span><span class="n">height</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="cm">/* Compute source pixel and check bounds in source */</span>
			<span class="n">CVector3</span> <span class="n">p_dest</span><span class="p">,</span> <span class="n">p_src</span><span class="p">;</span>
			<span class="n">p_dest</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>
			<span class="n">p_dest</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">;</span>
			<span class="n">p_dest</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">;</span>

			<span class="n">p_src</span> <span class="o">=</span> <span class="n">Minv</span> <span class="o">*</span> <span class="n">p_dest</span><span class="p">;</span>

			<span class="kt">float</span> <span class="n">x_src</span> <span class="o">=</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span> <span class="p">(</span><span class="n">p_src</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">p_src</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
			<span class="kt">float</span> <span class="n">y_src</span> <span class="o">=</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span> <span class="p">(</span><span class="n">p_src</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">p_src</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">x_src</span> <span class="o">&lt;</span> <span class="mf">0.0</span> <span class="o">||</span> <span class="n">x_src</span> <span class="o">&gt;=</span> <span class="n">img</span><span class="p">.</span><span class="n">Shape</span><span class="p">().</span><span class="n">width</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">||</span>
				<span class="n">y_src</span> <span class="o">&lt;</span> <span class="mf">0.0</span> <span class="o">||</span> <span class="n">y_src</span> <span class="o">&gt;=</span> <span class="n">img</span><span class="p">.</span><span class="n">Shape</span><span class="p">().</span><span class="n">height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="kt">int</span> <span class="n">xf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">floor</span><span class="p">(</span><span class="n">x_src</span><span class="p">);</span>
			<span class="kt">int</span> <span class="n">yf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">floor</span><span class="p">(</span><span class="n">y_src</span><span class="p">);</span>
			<span class="kt">int</span> <span class="n">xc</span> <span class="o">=</span> <span class="n">xf</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">yc</span> <span class="o">=</span> <span class="n">yf</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

			<span class="cm">/* Skip black pixels */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">img</span><span class="p">.</span><span class="n">Pixel</span><span class="p">(</span><span class="n">xf</span><span class="p">,</span> <span class="n">yf</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x0</span> <span class="o">&amp;&amp;</span> 
				<span class="n">img</span><span class="p">.</span><span class="n">Pixel</span><span class="p">(</span><span class="n">xf</span><span class="p">,</span> <span class="n">yf</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x0</span> <span class="o">&amp;&amp;</span> 
				<span class="n">img</span><span class="p">.</span><span class="n">Pixel</span><span class="p">(</span><span class="n">xf</span><span class="p">,</span> <span class="n">yf</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x0</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">img</span><span class="p">.</span><span class="n">Pixel</span><span class="p">(</span><span class="n">xc</span><span class="p">,</span> <span class="n">yf</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x0</span> <span class="o">&amp;&amp;</span> 
				<span class="n">img</span><span class="p">.</span><span class="n">Pixel</span><span class="p">(</span><span class="n">xc</span><span class="p">,</span> <span class="n">yf</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x0</span> <span class="o">&amp;&amp;</span> 
				<span class="n">img</span><span class="p">.</span><span class="n">Pixel</span><span class="p">(</span><span class="n">xc</span><span class="p">,</span> <span class="n">yf</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x0</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">img</span><span class="p">.</span><span class="n">Pixel</span><span class="p">(</span><span class="n">xf</span><span class="p">,</span> <span class="n">yc</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x0</span> <span class="o">&amp;&amp;</span> 
				<span class="n">img</span><span class="p">.</span><span class="n">Pixel</span><span class="p">(</span><span class="n">xf</span><span class="p">,</span> <span class="n">yc</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x0</span> <span class="o">&amp;&amp;</span> 
				<span class="n">img</span><span class="p">.</span><span class="n">Pixel</span><span class="p">(</span><span class="n">xf</span><span class="p">,</span> <span class="n">yc</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x0</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">img</span><span class="p">.</span><span class="n">Pixel</span><span class="p">(</span><span class="n">xc</span><span class="p">,</span> <span class="n">yc</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x0</span> <span class="o">&amp;&amp;</span> 
				<span class="n">img</span><span class="p">.</span><span class="n">Pixel</span><span class="p">(</span><span class="n">xc</span><span class="p">,</span> <span class="n">yc</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x0</span> <span class="o">&amp;&amp;</span> 
				<span class="n">img</span><span class="p">.</span><span class="n">Pixel</span><span class="p">(</span><span class="n">xc</span><span class="p">,</span> <span class="n">yc</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x0</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			
			<span class="kt">double</span> <span class="n">weight</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">;</span>
			<span class="c1">// set weight according to a feathering function</span>
									
			<span class="c1">//use the triangle to find the feathered weight if your within the blendwidth</span>
			<span class="c1">//x_src and y_src are the coordinates of the pixel in the single image coordinate space</span>
			<span class="c1">//x and y are the coordinate of the pixel in the panorama coordinate space</span>
			
			<span class="k">if</span> <span class="p">(</span><span class="n">x_src</span> <span class="o">&lt;</span> <span class="n">blendWidth</span><span class="p">){</span>
				<span class="n">weight</span> <span class="o">=</span> <span class="n">x_src</span><span class="o">/</span><span class="n">blendWidth</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">x_src</span> <span class="o">&gt;</span> <span class="n">img</span><span class="p">.</span><span class="n">Shape</span><span class="p">().</span><span class="n">width</span> <span class="o">-</span> <span class="n">blendWidth</span><span class="p">){</span>
				<span class="n">weight</span> <span class="o">=</span> <span class="p">(</span><span class="n">img</span><span class="p">.</span><span class="n">Shape</span><span class="p">().</span><span class="n">width</span> <span class="o">-</span> <span class="n">x_src</span><span class="p">)</span> <span class="o">/</span> <span class="n">blendWidth</span><span class="p">;</span>
			<span class="p">}</span>
			
			<span class="k">if</span><span class="p">(</span><span class="n">y_src</span> <span class="o">&lt;</span> <span class="n">blendWidth</span><span class="p">){</span>
				<span class="n">weight</span> <span class="o">=</span> <span class="n">weight</span><span class="o">*</span><span class="p">(</span><span class="n">y_src</span> <span class="o">/</span> <span class="n">blendWidth</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">y_src</span> <span class="o">&gt;</span> <span class="n">img</span><span class="p">.</span><span class="n">Shape</span><span class="p">().</span><span class="n">height</span> <span class="o">-</span> <span class="n">blendWidth</span><span class="p">){</span>
				<span class="n">weight</span> <span class="o">=</span> <span class="n">weight</span><span class="o">*</span><span class="p">(</span><span class="n">img</span><span class="p">.</span><span class="n">Shape</span><span class="p">().</span><span class="n">height</span> <span class="o">-</span> <span class="n">y_src</span><span class="p">)</span> <span class="o">/</span> <span class="n">blendWidth</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">acc</span><span class="p">.</span><span class="n">Pixel</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+=</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span> <span class="p">(</span><span class="n">weight</span> <span class="o">*</span> <span class="n">img</span><span class="p">.</span><span class="n">PixelLerp</span><span class="p">(</span><span class="n">x_src</span><span class="p">,</span> <span class="n">y_src</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
			<span class="n">acc</span><span class="p">.</span><span class="n">Pixel</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+=</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span> <span class="p">(</span><span class="n">weight</span> <span class="o">*</span> <span class="n">img</span><span class="p">.</span><span class="n">PixelLerp</span><span class="p">(</span><span class="n">x_src</span><span class="p">,</span> <span class="n">y_src</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
			<span class="n">acc</span><span class="p">.</span><span class="n">Pixel</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+=</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span> <span class="p">(</span><span class="n">weight</span> <span class="o">*</span> <span class="n">img</span><span class="p">.</span><span class="n">PixelLerp</span><span class="p">(</span><span class="n">x_src</span><span class="p">,</span> <span class="n">y_src</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>
			<span class="n">acc</span><span class="p">.</span><span class="n">Pixel</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+=</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span> <span class="n">weight</span><span class="p">;</span>

		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="normalizing-the-blend">Normalizing the Blend</h3>

<p>Here I normalize the blend which can be accomplished by simply dividing each color by the weight calculated in accumulate blend.</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="kt">void</span> <span class="nf">NormalizeBlend</span><span class="p">(</span><span class="n">CFloatImage</span><span class="o">&amp;</span> <span class="n">acc</span><span class="p">,</span> <span class="n">CByteImage</span><span class="o">&amp;</span> <span class="n">img</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">height</span> <span class="o">=</span> <span class="n">acc</span><span class="p">.</span><span class="n">Shape</span><span class="p">().</span><span class="n">height</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">width</span> <span class="o">=</span> <span class="n">acc</span><span class="p">.</span><span class="n">Shape</span><span class="p">().</span><span class="n">width</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">width</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">height</span><span class="p">;</span> <span class="n">y</span><span class="o">++</span><span class="p">){</span>
			<span class="n">img</span><span class="p">.</span><span class="n">Pixel</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="n">acc</span><span class="p">.</span><span class="n">Pixel</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">acc</span><span class="p">.</span><span class="n">Pixel</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
			<span class="n">img</span><span class="p">.</span><span class="n">Pixel</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">acc</span><span class="p">.</span><span class="n">Pixel</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">acc</span><span class="p">.</span><span class="n">Pixel</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
			<span class="n">img</span><span class="p">.</span><span class="n">Pixel</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">acc</span><span class="p">.</span><span class="n">Pixel</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">acc</span><span class="p">.</span><span class="n">Pixel</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
			<span class="c1">//assume Pixel(x,y,3) is defaulted to one</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="what-worked-well-and-what-did-not">What worked well and what did not?</h2>

<p>While testing the affine matrix transformation, the best results were obtained by using a shear matrix to deform the image as it was only shifted in the y direction. What did not work well was attempting to use a vertical translation calculated by the x coordinate because it was extremely difficult to figure out how to store that in a matrix. The affine shear matrix accomplishes the exact same thing, but with a more mathematical intuition than trying to determine it geometrically. Also the RANSAC worked extremely well even before applying a leastSquares best fit. But no harm in making it even better.</p>

        
      </section>

      <footer class="page__meta">
        
        


  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      <a href="/pages/dcyoung/categories/#computer-vision" class="page__taxonomy-item p-category" rel="tag">computer vision</a><span class="sep">, </span>
    
      <a href="/pages/dcyoung/categories/#school-project" class="page__taxonomy-item p-category" rel="tag">school project</a>
    
    </span>
  </p>


        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time class="dt-published" datetime="2015-10-01">October 1, 2015</time></p>

      </footer>

      <section class="page__share">
  

  <a href="https://twitter.com/intent/tweet?text=360+Panoramas+%28Alignment%2C+Stitching%2C+Blending%29%20https%3A%2F%2Fdcyoung.github.io%2Fpages%2Fdcyoung%2Fpost-image-panoramas%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fdcyoung.github.io%2Fpages%2Fdcyoung%2Fpost-image-panoramas%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://dcyoung.github.io/pages/dcyoung/post-image-panoramas/" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/pages/dcyoung/post-constraint-satisfaction-problems/" class="pagination--pager" title="Solving Constraint Satisfaction Problems
">Previous</a>
    
    
      <a href="/pages/dcyoung/post-adversarial-search/" class="pagination--pager" title="​Adversarial Search
">Next</a>
    
  </nav>

    </div>

    
      <div class="page__comments">
  
  
      <h4 class="page__comments-title">Comments</h4>
      <section id="utterances-comments"></section>
    
</div>

    
  </article>

  
  
    
<div class="page__related">
  
  <h2 class="page__related-title">You May Also Enjoy</h2>
  <div class="grid__wrapper">
    
      
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src="/pages/dcyoung/images/r3f-nn-visualizer/preview.webp" alt="">
      </div>
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/pages/dcyoung/post-r3f-nn-visualizer/" rel="permalink">Interactive Neural Network Visualizer
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          1 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">An interactive Neural Network visualization built w/ modern web technologies including tensorflow.js and react-three-fiber.
</p>
  </article>
</div>

    
      
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src="/pages/dcyoung/images/mmle-scores/softmax.webp" alt="">
      </div>
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/pages/dcyoung/post-mmle-scores/" rel="permalink">Practical ML: Detecting Out-of-Distribution Data
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          4 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Detecting out of distribution samples using
</p>
  </article>
</div>

    
      
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src="/pages/dcyoung/images/gh-pages-staging-deployments/preview.webp" alt="">
      </div>
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/pages/dcyoung/post-gh-pages-staging-deployments/" rel="permalink">Automating Free Staging Deployments for Github Pages
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          3 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Automating free staging deployments for Github Pages using Github Actions.
</p>
  </article>
</div>

    
      
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src="/pages/dcyoung/images/clustering-custom-distance/haversine.webp" alt="">
      </div>
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/pages/dcyoung/post-clustering-custom-distance/" rel="permalink">Performant Clustering of Geo Coordinates w/ Custom Distance Functions
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          3 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Implementing vectorized clustering methods for distance metrics unsupported by common libraries.
</p>
  </article>
</div>

    
  </div>
</div>

  
  
</div>

      
    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';" role="search">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    
      
        
          <li><a href="https://github.com/dcyoung" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
        
      
        
          <li><a href="https://www.instagram.com/cycle_shadez/" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-instagram" aria-hidden="true"></i> Instagram</a></li>
        
      
    

    
      <li><a href="/pages/dcyoung/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2024 <a href="https://dcyoung.github.io">David Young</a>. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/jekyll-themes/minimal-mistakes/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/pages/dcyoung/assets/js/main.min.js"></script>




<script src="/pages/dcyoung/assets/js/lunr/lunr.min.js"></script>
<script src="/pages/dcyoung/assets/js/lunr/lunr-store.js"></script>
<script src="/pages/dcyoung/assets/js/lunr/lunr-en.js"></script>




  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-8LFRSKS1E8"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-8LFRSKS1E8', { 'anonymize_ip': false});
</script>






    <script>
  'use strict';

  (function() {
    var commentContainer = document.querySelector('#utterances-comments');

    if (!commentContainer) {
      return;
    }

    var script = document.createElement('script');
    script.setAttribute('src', 'https://utteranc.es/client.js');
    script.setAttribute('repo', 'dcyoung/dcyoung.github.io');
    script.setAttribute('issue-term', 'pathname');
    script.setAttribute('label', 'comment');
    script.setAttribute('theme', 'github-light');
    script.setAttribute('crossorigin', 'anonymous');

    commentContainer.appendChild(script);
  })();
</script>

  




  </body>
</html>
